<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="这是个简介">
<meta property="og:type" content="website">
<meta property="og:title" content="吐核|Core Dump">
<meta property="og:url" content="http://blog.spider.im/index.html">
<meta property="og:site_name" content="吐核|Core Dump">
<meta property="og:description" content="这是个简介">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="吐核|Core Dump">
<meta name="twitter:description" content="这是个简介">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 吐核|Core Dump </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-36548399-1', 'auto');
  ga('send', 'pageview');
</script>




  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=63414042";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">吐核|Core Dump</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">笔记 随想 吐槽</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/08/lack-post-start-hook-error-message/" itemprop="url">
                  升级kubelet到1.7后PostStartHook的错误消息丢失问题追查
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-11-08T15:48:13+08:00" content="2017-11-08">
              2017-11-08
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/11/08/lack-post-start-hook-error-message/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/08/lack-post-start-hook-error-message/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于centos7 默认的3.10内核在cgroup使用cpu limit并且压力比较大的时候有kernal panic的 <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1687512" target="_blank" rel="external">bug</a> , 看了下是4.2某个版本后修复了这个问题，所以干脆我们升级了系统的内核到mainline版本4.13, 带来的问题是需要升kubelet到1.7（我们用的是1.7.8这个版本），注意升级kubelet最好机器上没有容器的情况下升级如果可能直接重装就好，人工升级的话需要自行创建/sys/fs/cgroup/rdma/kubepods 目录（这个也是查代码查了半天发现的具体就不说了）</p>
<p>由于我们的业务逻辑上，容器内的服务启动其实是通过PostStartHook实现的，所以非常依赖相关的Event日志来排查问题，结果发现升级到1.7.8版本后，event中的message字段变空的，并且kubelet日志中也没有相关的信息,猜测是版本变动，代码上有所变化所以就去追了下</p>
<p>核心代码在<a href="https://github.com/kubernetes/kubernetes/blob/release-1.7/pkg/kubelet/kuberuntime/kuberuntime_container.go#L143,L157" target="_blank" rel="external">pkg/kubelet/kuberruntime/kuberuntime_container.go</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 4: execute the post start hook.</span></span><br><span class="line"><span class="keyword">if</span> container.Lifecycle != <span class="literal">nil</span> &amp;&amp; container.Lifecycle.PostStart != <span class="literal">nil</span> &#123;</span><br><span class="line">	kubeContainerID := kubecontainer.ContainerID&#123;</span><br><span class="line">		Type: m.runtimeName,</span><br><span class="line">		ID:   containerID,</span><br><span class="line">	&#125;</span><br><span class="line">	msg, handlerErr := m.runner.Run(kubeContainerID, pod, container, container.Lifecycle.PostStart)</span><br><span class="line">	<span class="keyword">if</span> handlerErr != <span class="literal">nil</span> &#123;</span><br><span class="line">		m.recordContainerEvent(pod, container, kubeContainerID.ID, v1.EventTypeWarning, events.FailedPostStartHook, msg)</span><br><span class="line">		m.killContainer(pod, kubeContainerID, container.Name, <span class="string">"FailedPostStartHook"</span>, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"PostStart Hook Failed"</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到Event里面记录的是msg字段，那么很自然的想到应该是msg里面的东西变了，所以一路追下去。PS: 注意这段最后的函数return的地方，return的是个err 但是怎么看也应该是handlerErr，这个直觉给后面查问题带来了帮助</p>
<p>k8s的代码里面interface用的太多，IDE都不能很好的支持，不能直接跳到实际的代码的地方，费劲人肉看找了一圈，Run的函数实际代码就在这个文件下面</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RunInContainer synchronously executes the command in the container, and returns the output.</span></span><br><span class="line"><span class="keyword">func</span> (m *kubeGenericRuntimeManager) RunInContainer(id kubecontainer.ContainerID, cmd []<span class="keyword">string</span>, timeout time.Duration) ([]<span class="keyword">byte</span>, error) &#123;</span><br><span class="line">	stdout, stderr, err := m.runtimeService.ExecSync(id.ID, cmd, <span class="number">0</span>)</span><br><span class="line">	<span class="comment">// NOTE(timstclair): This does not correctly interleave stdout &amp; stderr, but should be sufficient</span></span><br><span class="line">	<span class="comment">// for logging purposes. A combined output option will need to be added to the ExecSyncRequest</span></span><br><span class="line">	<span class="comment">// if more precise output ordering is ever required.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">append</span>(stdout, stderr...), err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这个里面的注释：This does not correctly interleave stdout &amp; stderr</p>
<p>然后ExecSync的代码实际在[pkg/kubelet/dockershim/docker_streaming.go]</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (r *streamingRuntime) Exec(containerID <span class="keyword">string</span>, cmd []<span class="keyword">string</span>, in io.Reader, out, err io.WriteCloser, tty <span class="keyword">bool</span>, resize &lt;-<span class="keyword">chan</span> remotecommand.TerminalSize) error &#123;</span><br><span class="line">	<span class="keyword">return</span> r.exec(containerID, cmd, in, out, err, tty, resize, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Internal version of Exec adds a timeout.</span></span><br><span class="line"><span class="keyword">func</span> (r *streamingRuntime) exec(containerID <span class="keyword">string</span>, cmd []<span class="keyword">string</span>, in io.Reader, out, errw io.WriteCloser, tty <span class="keyword">bool</span>, resize &lt;-<span class="keyword">chan</span> remotecommand.TerminalSize, timeout time.Duration) error &#123;</span><br><span class="line">	container, err := checkContainerStatus(r.client, containerID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r.execHandler.ExecInContainer(r.client, container, cmd, in, out, errw, tty, resize, timeout)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> (r *streamingRuntime) Attach(containerID <span class="keyword">string</span>, in io.Reader, out, errw io.WriteCloser, tty <span class="keyword">bool</span>, resize &lt;-<span class="keyword">chan</span> remotecommand.TerminalSize) error &#123;</span><br><span class="line">	_, err := checkContainerStatus(r.client, containerID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> attachContainer(r.client, containerID, in, out, errw, tty, resize)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这段代码是进到docker容器中类似于exec的方式执行了hook脚本，并且把标准输入和标准输出获取了出来。所以Msg应该是脚本的标准输出和标准错误，这里看了半天，感觉没有半毛钱毛病，并且试了下让脚本输出点东西到1和2里面，但是也没Get到任何信息</p>
<p>然后想起了2件事情：</p>
<ol>
<li>那个注释：貌似这段代码根本就没成功实现把1和2拿出来的功能</li>
<li>感觉写错的那个err字段，应该是handlerErr的，并且平常获取到的错误信息command ‘/xxxxxx’ exited with 1: Hook do errexit, this is stderr</li>
</ol>
<p>觉得应该return的和丢到event里面的应该是handlerErr ，找了下1.6的代码，发现</p>
<p>有一段</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := fmt.Errorf(<span class="string">"PostStart handler: %v"</span>, handlerErr)</span><br></pre></td></tr></table></figure>
<p>然后去了找了下发现有个大哥在这个代码里面删了，2333<br>
<a href="https://github.com/kubernetes/kubernetes/commit/a02f10fa3a956a2fc1fe0328f58b7b1cea548264" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/commit/a02f10fa3a956a2fc1fe0328f58b7b1cea548264</a></p>
<p>我自行改了下代码编译了个kubelet跑了试了下，发现确实是这么个问题。<br>
去提了个Issue <a href="https://github.com/kubernetes/kubernetes/issues/54671" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/issues/54671</a> 想说之后的版本能修下来着，<br>
但是可惜的是k8s master的代码和分支已经很不一样了，并且社区也不修1.7这个系列的问题，再发小版本了。</p>
<p>后续：</p>
<ol>
<li>本来我打算是自己编译kubelet自己维护的，但是组内的同学不太同意，毕竟我们人少，未来维护是问题</li>
<li>发现业务逻辑依赖这个有点风险，所以我们最终改成了hook脚本自己把错误汇报上来的机制</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/16/mid-year-summary/" itemprop="url">
                  2017年中总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-16T15:22:06+08:00" content="2017-08-16">
              2017-08-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/08/16/mid-year-summary/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/16/mid-year-summary/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>虽然都已经8月份了，但是突然想写下年中总结，总结下这段时间的工作，生活情况</p>
<h2 id="首先说下年初的时候："><a class="header-anchor" href="#首先说下年初的时候：">¶</a>首先说下年初的时候：</h2>
<p>去年年末跟家里面说打算买房，一方面是家里面催婚有点烦躁(其实我也没在管的，当时还在认真工作，没太想这方面的事情)，另外一方面是想给点自己点压力，让自己做些变化。最终在元旦的时候把房子搞定了，爸妈把自己手头仅有的20w给了我，问同学同事借了将近30w中转，然后苦哈哈的熬到3月份的时候把借同学同事的钱从各种理财以及卖掉股票都弄出来还掉了（借钱还是挺蛋疼的，幸亏这几个同龄的同学和同事都不急着有钱而且我们这种工作的手头的钱都还比较多），然后等到5月份的时候公积金提出来，父母给的钱也算cover掉了，总体算首付是自己搞定的，不枉我在北京苦熬了么4年。 买房子这件事情嘛，还是有点迟了，应该去年10月份刚限购的时候买更好些, 房子还算满意，就是选择不多，楼层的数字不好，当然也总比现在买好，大家看破了限购带来不了什么市场行情的下降，又开始抢房子，买房需要摇号了。</p>
<h2 id="再说下三月份换工作的事情："><a class="header-anchor" href="#再说下三月份换工作的事情：">¶</a>再说下三月份换工作的事情：</h2>
<p>我这人其实有点慵懒，不是特别愿意动，不然不会在百度待了那么久，虽然在去年年初换到了<a href="/2016/04/09/summary-baidu-ops/">糯米</a>.<br>
而这次换的主要原因是发展不太好，评职称我猜到肯定评不上去，工资在糯米总体绩效又差，很难有提升。所以想着尽快换个地方吧。<br>
当时面了3个地方：快手，陌陌，京东。快手有同学在那，听说很牛逼，所以去看看，面的是去做运维的，有点不想去，也没认真准备，然后就GG了，还是有点耻辱的（面运维居然能挂，还是不会说话啊）；陌陌是之前在糯米的时候合作过，感觉不错，发展也挺好，面的方向还是类似糯米的PHP业务研发，面过了，然而有了第三个选择；京东其实是我自己故意找去的，主要是知道之前Noah团队不少人都在，而且我有点想往这个方向做下去，不然之前几年运维经验浪费了，所以把简历给了董钊，和臧爷聊了聊，走了下面试流程，虽然我资质愚钝还是让我进去了。（PS：其实我不想做部署的想做做监控，部署之前弄过了，不过还好现在是基于k8s做PAAS，有些新的调整）。最终选择京东的原因呢，一方面是团队靠谱放心，另外一方面钱多。。。</p>
<h2 id="再絮叨下3月份到现在的事情："><a class="header-anchor" href="#再絮叨下3月份到现在的事情：">¶</a>再絮叨下3月份到现在的事情：</h2>
<p>3月13到了京东，开始做运维平台的事情(后来发现这个团队也差不多是刚成立没多久)。先学Go语言，然后顺道模仿着前人的代码独立弄了个配置中心，用于管理应用的配置文件（这个是和百度不一样的,百度都是研发自己维护在产品库里面或者大搜一样一部分在运维的产品库一部分在研发的产品库，有利有弊），然后起了个很骚气的名字confcenter（spider的rd应该都知道这个:) ）;与此同时开始弄基于kubernetes的PAAS平台，主要功能是部署，然后顺道弄了编译+产品库+镜像管理的事情，这个后面有空细说，还是挺有趣的。差不多2到3个月吧，系统就基本成型了。7月份8月份就在大力推广使用了。节奏还是有点快的，后面还是得做一下稳定性的事情。然后期间还插了个事情，做了个类似archer的包部署系统（用物理机而不是容器），一周搞定（之前在狼厂的经验，方案基本不用讨论，很快定下开搞就行了），解决有状态的服务部署的问题。这差不多就是这段时间工作上的事情。</p>
<p>然后是感情上的事情：不太好说，只能说是遇上了一个喜欢的人，一个很可爱的小姑凉，有时候有点软萌，笑，但是不知为啥心里面对她总是有点慌慌的怕怕的，可能是喜欢她，所以紧张着吧，思考。和我一样也是个有些内向的人，内心活动会比较多吧，有时候觉得她心思有些重，皱眉。然后在遇上她的这段时间里，有人评价我变傻了，逻辑能力变差了，我自己想了想，在她面前我确实宛如一个智障，恩。难得碰上一个喜欢的菇凉，想跟她一起走下去的，可惜她貌似不喜欢我，而且感觉连备胎都没当上，十分惨烈。另外我得反思下我自己，有时候真想抽自己，实在太不会追女生了，实际的行动没付出过啥，约她吃饭，想送她回家，被拒绝后就有点心灰意冷没再表示了，并且太掏心窝子表爱意了，感觉吓到她了，不应该还没关系成熟的时候就这样的，检讨。哎。。。</p>
<h2 id="未来的规划："><a class="header-anchor" href="#未来的规划：">¶</a>未来的规划：</h2>
<p>以找妹子为第一任务2333，要多勾搭，男人不能含蓄；深入目前做的PAAS系统，多看看kubernetes的相关代码，深入一些；基本功得补一补，扎实一些；多看看别的书，扩展扩展自己的兴趣，提高下情商</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/22/php-static-binding/" itemprop="url">
                  php后期静态绑定
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-22T13:29:18+08:00" content="2017-02-22">
              2017-02-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/22/php-static-binding/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/02/22/php-static-binding/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在看Yii2代码的时候，有这么一段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (isset(static::$classMap[$className])) &#123;</span><br><span class="line">     $classFile = static::$classMap[$className];</span><br><span class="line">     if ($classFile[0] === &apos;@&apos;) &#123;</span><br><span class="line">         $classFile = static::getAlias($classFile);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125; elseif (strpos($className, &apos;\\&apos;) !== false) &#123;</span><br><span class="line">     $classFile = static::getAlias(&apos;@&apos; . str_replace(&apos;\\&apos;, &apos;/&apos;, $className) . &apos;.php&apos;, false);</span><br><span class="line">     if ($classFile === false || !is_file($classFile)) &#123;</span><br><span class="line">         return;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>当时有点困惑，为啥用了个static::$classMap[$className],而不是self::$classMap[$className],细看了下self和static的区别<br>
大体可以理解为static定义的function 如果子类又重新实现了的话，会用子类的结果（实际运行的时候的），而self永远是最开始定义的父类的结果</p>
<p>与self类似的还有 <strong>CLASS</strong> 和get_class() 只会是最开始定义的结果,不过注意get_class($this)会是实际运行时的类的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class A &#123;</span><br><span class="line">    static $staticString = &quot;A static string&quot;;</span><br><span class="line">    public static function staticFunction() &#123;</span><br><span class="line">        echo self::$staticString;</span><br><span class="line">    &#125;</span><br><span class="line">    public static function foo() &#123;</span><br><span class="line">        echo &quot;Afoo:&quot;.__CLASS__.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public static function selfFoo() &#123;</span><br><span class="line">        echo &quot;called class:&quot;.get_called_class().&quot;\n&quot;;</span><br><span class="line">        echo &quot;class:&quot;.get_class().&quot;\n&quot;;</span><br><span class="line">        echo self::foo();</span><br><span class="line">    &#125;</span><br><span class="line">    public static function staticFoo() &#123;</span><br><span class="line">        echo &quot;called class:&quot;.get_called_class().&quot;\n&quot;;</span><br><span class="line">        echo &quot;class:&quot;.get_class().&quot;\n&quot;;</span><br><span class="line">        echo static::foo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class B extends A &#123;</span><br><span class="line">    static $staticString = &quot;B static string&quot;;</span><br><span class="line">    public static function foo() &#123;</span><br><span class="line">        echo &quot;Bfoo:&quot;.__CLASS__.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public static function parent() &#123;</span><br><span class="line">        parent::selfFoo();</span><br><span class="line">        parent::staticFoo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class C extends B &#123;</span><br><span class="line">    public static function foo() &#123;</span><br><span class="line">        echo __CLASS__;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">B::selfFoo();</span><br><span class="line">/*</span><br><span class="line">输出结果</span><br><span class="line">called class:B</span><br><span class="line">class:A</span><br><span class="line">Afoo:A</span><br><span class="line">*/</span><br><span class="line">B::staticFoo();</span><br><span class="line">C::parent();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class base_class</span><br><span class="line">&#123;</span><br><span class="line">    function say_a()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;&apos;a&apos; - said the &quot; . __CLASS__ . &quot;&lt;br/&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function say_b()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;&apos;b&apos; - said the &quot; . get_class($this) . &quot;&lt;br/&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class derived_class extends base_class</span><br><span class="line">&#123;</span><br><span class="line">    function say_a()</span><br><span class="line">    &#123;</span><br><span class="line">        parent::say_a();</span><br><span class="line">        echo &quot;&apos;a&apos; - said the &quot; . __CLASS__ . &quot;&lt;br/&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function say_b()</span><br><span class="line">    &#123;</span><br><span class="line">        parent::say_b();</span><br><span class="line">        echo &quot;&apos;b&apos; - said the &quot; . get_class($this) . &quot;&lt;br/&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj_b = new derived_class();</span><br><span class="line"></span><br><span class="line">$obj_b-&gt;say_a();</span><br><span class="line">echo &quot;&lt;br/&gt;&quot;;</span><br><span class="line">$obj_b-&gt;say_b();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>The output should look roughly like this:</p>
<p>‘a’ - said the base_class<br>
’a’ - said the derived_class</p>
<p>‘b’ - said the derived_class<br>
’b’ - said the derived_class</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/15/api-security/" itemprop="url">
                  API接口签名验证方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-15T11:23:45+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/15/api-security/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/15/api-security/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要是和外部合作的时候需要考虑的安全性问题，首先是必须走HTTPS不多说，其次是接口上需要添加相应的校验，基本思路是给请求的参数添加个校验参数，不过实际做法各不一样，这里记录下我碰到的几种模式以及我自己的思考</p>
<h2 id="参数签名模式"><a class="header-anchor" href="#参数签名模式">¶</a>参数签名模式</h2>
<p>通用接口，仅仅添加一个校验参数，sign值是其他所有参数按照校验算法计算出来的（需要要加个不在URL参数里面带的密钥）这种对 GET 和 POST 都是类似的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 密钥生成算法</span><br><span class="line"> * @param array $params 需要加密的参数对(一般是url的参数)</span><br><span class="line"> *        string $sha1 密钥</span><br><span class="line"> * @return string</span><br><span class="line"> */</span><br><span class="line">public static function getIntSign($params, $sha1) &#123;</span><br><span class="line">    ksort ( $params, SORT_STRING ); // 对参数的key以字母顺序排序</span><br><span class="line">    $paramsArr = array ();</span><br><span class="line">    foreach ( $params as $pkey =&gt; $pval ) &#123;</span><br><span class="line">        if ($pkey == &quot;token&quot; || $pkey == &quot;log_id&quot;) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        array_push ( $paramsArr, ($pkey . &quot;:&quot; . $pval) ); // 用冒号连结参数的key和val</span><br><span class="line">    &#125;</span><br><span class="line">    $hashString = implode ( &quot;_&quot;, $paramsArr ); // 用下划线连结各参数(key,val)对</span><br><span class="line">    $hashString = $hashString . &quot;_&quot; . $sha1; // 在最后加上有效的sha1值</span><br><span class="line">    $intSign = sha1 ( $hashString );</span><br><span class="line">    return $intSign;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>校验也很简单，把所有参数丢到生成算法里面，计算下和sign值结果是不是一样的就行了</p>
<p>还看到一个微服务提供给不同的app，略有不同</p>
<ol>
<li>URL参数里面带上分配的appkey</li>
<li>对于post的请求，需要对post体进行校验比如md5下生成checkStr</li>
<li>同样需要个sign值 对get的参数进行 appkey+checkStr 生成sign</li>
</ol>
<h2 id="唯一性保证"><a class="header-anchor" href="#唯一性保证">¶</a>唯一性保证</h2>
<p>在上面的基础上添加timestamp，服务端看这个timestamp 不能超过指定时间长度，超过失效。这个对更新类的请求有用，别人不能重复发请求获取最新数据。</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/21/speed-hhvm/" itemprop="url">
                  速度优化HHVM篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-21T22:47:49+08:00" content="2016-08-21">
              2016-08-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/21/speed-hhvm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/21/speed-hhvm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>确定的第一个速度优化的项目:</p>
<p>从PHP5.4切换到HHVM<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，为什么？因为这个方案效果是已知的好，省CPU，明显提升速度！实践起来简单（不用改代码就能有提升），并且在公司内部也已经经过多年使用，兼容性会有但问题不大。</p>
<p>HHVM是什么，介绍的文章太多了，这里就不叙述了，参见多益大神<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>的<a href="http://wuduoyi.com/note/hhvm/" target="_blank" rel="external">文章</a>，另外厂内HHVM维护者志广的<a href="http://saiyaren.iteye.com/" target="_blank" rel="external">博客</a> 也可以看看，虽然不怎么更新了。</p>
<h1>HHVM的使用情况</h1>
<p>HHVM在百度内部的情况使用这篇<a href="http://lamp.baidu.com/2014/11/04/hhvm-in-baidu/" target="_blank" rel="external">博客</a>有介绍，<br>
最重要的几个产品线在13年末14年初基本都实现了PHP到HHVM的切换工作,并且有大量的产品线正在使用。好奇我们为啥当时没用，建议以后都默认使用HHVM除了PHP7之外都不要考虑Zend-PHP了。</p>
<h1>HHVM能带来什么提升</h1>
<p>一个词形容就是“节省”，省时间（php执行速度加快）、省内存、省CPU。</p>
<p>这里罗列下基础调研数据</p>
<p>外部情况</p>
<ol>
<li>Wikimedia：维基百科部署了 HHVM 后，CPU 的负载从50%降到了10%，用户提交编辑时的平均响应时间减少到原来的一半，页面的平均加载时间从原来的1.3秒降到了0.9秒。</li>
<li>Etsy: Etsy 的工程师对比了HHVM 和 PHP5.4 的性能，发现 HHVM 每秒可以处理280个服务器请求，而对于 PHP5.4，如果每秒的请求数超过了190次，服务器的响应时间就会急剧增加。</li>
</ol>
<p>内部情况</p>
<ol>
<li>检索模板渲染用HHVM处理，处理时间减少一半(对比PHP-FPM+eAccelerator)，资源消耗上PHP-CGI用3.2G，HHVM用1G</li>
<li>广告模板系统渲染时间下降60%，整体响应时间下降50%</li>
</ol>
<p>我们自己的实践数据</p>
<ol>
<li>栋哥在优化后端接口性能的时候发现，发现始终有20ms不知道哪占的，最后发现是框架占的，使用HHVM之后，这20ms被压缩到1ms，效果明显</li>
</ol>
<h1>HHVM的问题</h1>
<ol>
<li>我所知道的最大的问题是有内存泄露问题，流量大的情况下，需要定期重启，不然HHVM自己重启，流量又没切走，会造成拒绝的问题，这个虽然在不断修复，不过今年在搜索还是有</li>
<li>插件的问题，插件不兼容，需要重新开放，不过常用的插件都有HHVM的版本了，我们没有这个问题</li>
<li>不兼容的问题，HHVM和PHP还不是100%兼容，虽然主流的PHP项目都对HHVM做了兼容，但是那也是针对官方HHVM而言，公司内的HHVM可能还有问题</li>
</ol>
<h1>HHVM和PHP的DIFF问题</h1>
<h2 id="hhvm传超过一个参数时精度丢失的问题"><a class="header-anchor" href="#hhvm传超过一个参数时精度丢失的问题">¶</a>hhvm传超过一个参数时精度丢失的问题</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $a1 = array(&apos;rate&apos;=&gt;4/3);</span><br><span class="line">    $a2 = array(&apos;col&apos;=&gt;4,&apos;rate&apos;=&gt;4/3);</span><br><span class="line"></span><br><span class="line">    function getit($r) &#123;</span><br><span class="line">        echo ( 4 * (6+17) - 17 ) * $r[&apos;rate&apos;] ;</span><br><span class="line">        echo &quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    getit($a1);</span><br><span class="line">    getit($a2);</span><br></pre></td></tr></table></figure>
<p>HHVM输出</p>
<pre><code>100
99.999999997
</code></pre>
<p>PHP输出</p>
<pre><code>100
100
</code></pre>
<h2 id="hhvm-htmlspecialchars对传参的限制问题"><a class="header-anchor" href="#hhvm-htmlspecialchars对传参的限制问题">¶</a>hhvm htmlspecialchars对传参的限制问题</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $string = array(&apos;str&apos;=&gt;&apos;aaa&apos;);</span><br><span class="line">  $str = htmlspecialchars($string, ENT_QUOTES, &apos;UTF-8&apos;);</span><br><span class="line">  echo ( $str );</span><br></pre></td></tr></table></figure>
<p>HHVM输出</p>
<pre><code>Array
</code></pre>
<p>PHP无输出</p>
<h2 id="mb库默认编码问题"><a class="header-anchor" href="#mb库默认编码问题">¶</a>mb库默认编码问题</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $search = &quot;日&quot;;</span><br><span class="line">  $subject = &quot;21日&quot;;</span><br><span class="line">  $replace = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">  #mb_regex_encoding(&apos;UTF-8&apos;);</span><br><span class="line">  #mb_internal_encoding(&quot;UTF-8&quot;);</span><br><span class="line">  $parts = mb_split(preg_quote($search), $subject);</span><br><span class="line">  $subject = implode($replace, $parts);</span><br><span class="line">  echo $subject.&quot;\n&quot;;</span><br></pre></td></tr></table></figure>
<p>HHVM输出</p>
<pre><code>21日
</code></pre>
<p>PHP输出</p>
<pre><code>21
</code></pre>
<h2 id="preg-match和魔术函数共用导致的死循环问题"><a class="header-anchor" href="#preg-match和魔术函数共用导致的死循环问题">¶</a>preg_match和魔术函数共用导致的死循环问题</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class MM&#123;</span><br><span class="line">  function getVar()&#123;</span><br><span class="line">    return $this;</span><br><span class="line">  &#125;</span><br><span class="line">  function __get($name)&#123;</span><br><span class="line">    return NULL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$t = new MM();</span><br><span class="line">echo preg_match_all(&quot;/./&quot;, &apos;some&apos;, $t-&gt;getVar()-&gt;value);</span><br><span class="line">echo &quot;\n&quot;;</span><br></pre></td></tr></table></figure>
<h2 id="rawurlencode-转义-线的问题"><a class="header-anchor" href="#rawurlencode-转义-线的问题">¶</a>rawurlencode 转义~线的问题</h2>
<p>HHVM支持的是PHP5.4，所以使用rawurlencode时不将<sub>转义为%7E保持原有的</sub>（PHP5.3以上都是如此支持），我们公司默认使用的是php 5.2.17,5.2.17将~转义为%7E，为了保持一致公司的HHVM Patch掉了这个，所以和我们用PHP5.4的又不兼容了。。。</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>其实还有个选择是PHP7，业界也有<a href="http://www.iteye.com/news/31607" target="_blank" rel="external">使用案例</a>,不过百度内部还没release，所以不太好使用，暂时不太想第一个吃螃蟹 <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2" class="footnote-item"><p>多益大神本身是个FE哦，牛逼人物基本都是FullStack <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/21/speed-investigate-and-survey/" itemprop="url">
                  速度优化相关调研
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-21T18:53:12+08:00" content="2016-08-21">
              2016-08-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/speed/" itemprop="url" rel="index">
                    <span itemprop="name">speed</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/21/speed-investigate-and-survey/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/21/speed-investigate-and-survey/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要记录下速度优化相关的调研</p>
<h1>速度指标定义与监控方案</h1>
<h2 id="速度指标定义"><a class="header-anchor" href="#速度指标定义">¶</a>速度指标定义</h2>
<p>如上文所述，做速度优化，需要给速度进行量化定义</p>
<p>调研了下速度指标的定义方式</p>
<ol>
<li>网页类产品：比如搜索，其实相对比较简单只有2个页面：首页、结果页，速度指标都是以首屏时间80分位来定义，这个首屏时间指核心DOM加载时间，比如搜索结果页就是网页中部，不包含右边和最底下推荐的搜索结果主体部分，而不是指占满整个屏幕的时间；但是移动端又不一样，移动端由于屏幕大小的限制以及操作方式，整个屏幕都是正文，这个首屏时间又变成了真正的首屏时间，就是占据屏幕的时间，不过一般打点都会往下打，防止用户快速下滑，这个</li>
<li>端上产品：端上情况比较复杂</li>
</ol>
<ul>
<li>第一种 其实还是网页，比如京东和美团不少页面<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，定义方法类似1</li>
<li>第二种 是个网页但又不仅仅是个网页，这种主要是通过JS来调用APP本身的能力来进行渲染展现，可以理解成是个本地的网页，然后后端主要是输出接口</li>
<li>第三种 完全是Native实现</li>
</ul>
<p>上面第二种和第三种大体还是类似于网页但是又不太是，还依赖端的一些能力，所以端本身也要消耗一些时间</p>
<p>理想的速度指标应该反映出用户的浏览速度体验，我看到有一个指标很不错，叫做用户可操作时间，最终还是需要结合业务进行制定。</p>
<h2 id="监控方案"><a class="header-anchor" href="#监控方案">¶</a>监控方案</h2>
<p>网页类的产品监控方式2种</p>
<ol>
<li>多地采集点进行页面性能监控，早年这个东西做的最好的是基调网络（主要是采集点多）后来出现不少此类产品，监控宝、各种云（阿里云 百度BCE）里面都自带类似工具；不过这个方案其实只适合做网站可用性监控，页面性能监控基本被淘汰了，毕竟一方面配置的页面不可能太全，覆盖面有限，另外一方面这种东西实现方式不一，很多前端优化在这个上面体现不出来。</li>
<li>网页自身JS打点，把所有需要的信息带在参数里面去访问一个空图片，然后后端统计日志，计算出来，再做个展示的平台，这个虽然看上去要做的事情比用现成的方案多，但是这个基本是目前的主流，另外百度内部也有现成的做好的平台，直接引用JS再设置下就行，另外JS打点的逻辑也值得说下，见脚注<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></li>
</ol>
<p>APP类的产品监控方式也有2种</p>
<ol>
<li>类似上面网页监控方式的1，代表产品是听云、博瑞、oneAPM等，和网页监控的区别就是这个是走的移动网络的监控点，可能是一堆手机在那监控。。。这个事情其实类似上面的问题，做过的基本都是以失败告终，意义实在不大，不是说APM意义不大，APM是另外一个概念，是在APP里面嵌入SDK</li>
<li>客户端日志回传，自己的东西还是自己清楚，利用客户端本身的能力去记录</li>
</ol>
<h1>速度优化方案</h1>
<p>看到的一些常见的速度优化方案，这里聚合罗列下，冒号后面是我的理解和解释</p>
<h2 id="基础网络"><a class="header-anchor" href="#基础网络">¶</a>基础网络</h2>
<ol>
<li>全国多接入点：移动网络下，网络传输时间占据了相当大的一个比例，所以接入点越多离用户越近速度越快，这里要具体分析下自己业务的用户群体以及网络情况</li>
<li>BGP接入：由于跨运营商的问题，对于移动应用，3大运营商接入点必须有，否则会出现各种奇怪的现象（移动会对跨网流量随机丢包）</li>
<li>动态代理加速？</li>
</ol>
<h2 id="基础层协议参数"><a class="header-anchor" href="#基础层协议参数">¶</a>基础层协议参数</h2>
<ol>
<li>优化拥塞窗口</li>
<li>TFO TLP</li>
<li>长连接</li>
<li>Chunked：http 流式异步传输协议；服务端收到请求后分段返回，浏览器立即渲染。</li>
</ol>
<h2 id="应用层协议"><a class="header-anchor" href="#应用层协议">¶</a>应用层协议</h2>
<ol>
<li>Head压缩：这里指发送请求的头部大小，有实验证明发送请求的头部大小会强烈影响首字节，基本结论是在1000字节以下，请求时间随头部大小增加变化明显，在1000字节之上，呈缓慢的上升趋势，后续详细实验下</li>
<li>HttpDns IP方式访问后端 : 这个腾讯写的一个<a href="http://mp.weixin.qq.com/s?__biz=MzA3ODgyNzcwMw==&amp;mid=201837080&amp;idx=1&amp;sn=b2a152b84df1c7dbd294ea66037cf262&amp;scene=2&amp;from=timeline&amp;isappinstalled=0" target="_blank" rel="external">文章</a>介绍的比较详细，DNSPOD也有现成的<a href="https://www.dnspod.cn/httpdns/guide" target="_blank" rel="external">产品</a>。百度看资料实际很早之前也有了，然而又是秘而不发。最早可能是为了防止DNS劫持，不过也可以用来提速，把DNS解析时间干掉，实现成端预请求获得所有APP要访问的域名和IP列表，请求都走IP（不过这个可能有限制，可能需要全部改成POST请求，不然依赖域名的接入服务，就没有办法路由请求了)</li>
<li>Spdy Quic：Spdy是HTTPS的多路复用，介绍HTTPS握手时间（考虑到我们已经全部是HTTPS了） QUIC是用UDP承载HTTPS的流量，不过这些都处于调研阶段，需要端上配合，服务端使用也不是太普遍，没看到内部实践例子，可能比较难实践</li>
</ol>
<h2 id="前端页面优化"><a class="header-anchor" href="#前端页面优化">¶</a>前端页面优化</h2>
<ol>
<li>理想页面布局：css前置，js后置尾部，html的js回调</li>
<li>理想页面内容：gzip 压缩页面size，减少js，减少图片数和size。</li>
<li>DNS预解析：和HttpDns目的类似，干掉DNS解析时间，毕竟移动网络DNS解析要几十ms呢</li>
<li>资源预测加载：提前加载图片资源，图片预取，资源预取</li>
<li>页面分块加载：这个我们用不到，指PC网页的，移动网页没有那么多块，顶多是把首屏下面的分块加载</li>
<li>异步化：这个提醒在搜索引擎上就是instant search，具体可以google 谷歌的实现</li>
</ol>
<h2 id="服务端优化"><a class="header-anchor" href="#服务端优化">¶</a>服务端优化</h2>
<h3 id="服务端前端"><a class="header-anchor" href="#服务端前端">¶</a>服务端前端</h3>
<ol>
<li>并行渲染：不懂，应该是smarty相关的，我们都是接口不出页面用不到</li>
<li>HHVM：HHVM方案已经比较成熟了，对于CPU和速度都有很显著的提升，这个是在多个产品上有过证明的，当然HHVM本身会代理一些兼容性问题，可能需要修改PHP代码</li>
<li>调度串行改并行：服务端前端基本是调用一堆后端，PHP程序员的思维基本是串行写逻辑，这个需要改下，把所有请求改成并行的，建议是先并行请求需要的数据，然后根据返回的数据在串行写自己的逻辑，可能会导致代码的可读性变差些，就看怎么实现的优雅点了。</li>
<li>图片压缩 Base64编码：移动端不需要过大的图，毕竟屏幕大小在那，而且很多图根本不会让用户放大了看，所以适当的压缩下图片大小，可以结合用户的网络制式和屏幕大小来动态调整，至于不是外链的图，自己产生的图可以直接base64返回，不变的图，前端直接放在前端代码里。</li>
<li>慢速识别，简版展现：这个之前管过，叫做速度适配，基本思路是根据用户的网络情况，展现不一样的网页，慢速的展现简版的网页，快速的展现元素多比较炫的网页，不过我们是服务端是不渲染HTML的，都是前端渲染的，而且这个得跟PM和UE聊聊，不一定同意。</li>
</ol>
<h3 id="服务端后端"><a class="header-anchor" href="#服务端后端">¶</a>服务端后端</h3>
<ol>
<li>全局全机房Cache：全机房统一全局Cache可以明显提升命中率，但是也有稳定性风险，异常就没有备份了</li>
<li>预充Cache：预充预取是移动端提速2大法宝，先模拟用户访问，预充下Cache，真正用户访问时就已经在Cache里面了</li>
<li>并行计算</li>
</ol>
<h2 id="预取架构"><a class="header-anchor" href="#预取架构">¶</a>预取架构</h2>
<p>这个有一套大的架构，并且有很多有趣的策略，不过都是很个性化的，这里不方便说，主要方法是提前把用户可能要访问的东西请求回来，用户真正点的时候直接加载了</p>
<p>这个网页通过JS就可以弄，但是App里面还依赖App本身，感觉我们App的实现不一定能搞预取的事情。</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>区别1和2最好的判断方式是在移动访问下查看页面有没有被插入运营商的流量球。。。经常看到京东和美团的APP内部被插入运营商流量球，感觉好low，即是个网页还没有HTTPS <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2" class="footnote-item"><p>要监控的数据: 白屏时间、首屏时间、用户可操作时间、Timing API数据（DNS TCP连接 首字节 传输完成 domComplete loadEventEnd) 白屏时间监控放在head底部（因为浏览器只有加载并解析完头部才会真正开始渲染页面,可以通过这个来监控白屏时间)，首屏时间（放在HTML代码渲染时，浏览器上首屏末尾处DOM元素所在的代码位置处，会计算首屏内图片加载的耗时当成首屏时间），用户可操作时间（在domready的地方标记） <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/16/speed-kickoff/" itemprop="url">
                  速度优化起始篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-16T10:58:39+08:00" content="2016-08-16">
              2016-08-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/speed/" itemprop="url" rel="index">
                    <span itemprop="name">speed</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/16/speed-kickoff/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/16/speed-kickoff/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>随着业务的发展，终于要开始搞速度优化了，很久之前以运维的身份参与过一定时间的速度优化项目，现在以研发的身份再参与一次，体会下不同的角度不同的方法</p>
<h1>为什么要进行速度优化</h1>
<ul>
<li>Amazon每增加100ms 收入下降1%;</li>
<li>Yahoo每降低400ms的加载时间，他们的访问量就提升9%</li>
<li>Mozilla将他们的页面速度提升了2.2s，每年多获得了1.6亿下载量</li>
<li>搜索首屏时间每增加300ms 无点击比例上升1%</li>
</ul>
<p>一般情况下认为移动端用户对访问速度的比PC端高，但是也有界限<br>
用户体验：&lt;2s，响应快；2<sub>5s，还可以；5</sub>8s，慢，还可以接受；&gt;8s，流失</p>
<p>总结下就是</p>
<ol>
<li>用户访问速度对用户体验至关重要</li>
<li>用户访问速度快慢影响收入</li>
</ol>
<h1>优化的目标是什么</h1>
<p>对于PC产品速度指标以1s为界限，移动端产品速度如上所述至少在2s内，最好能在1.5s内，能达到1s内就是完美</p>
<pre><code>这里指的时间都是按80分位值计算
</code></pre>
<h1>面临的挑战是什么</h1>
<ul>
<li>移动网络复杂不稳定的网络情况会带来很多不可控因素</li>
<li>业务早期粗放的发展模式积累了大量性能低下的代码</li>
<li>投入人力有限运维配合程度低，能获取到系统资源有限</li>
</ul>
<h1>速度优化被安排的职责</h1>
<ol>
<li>负责团队用户可见组件(及其依赖)的性能评判</li>
<li>负责性能优化方案的调研和制定，并逐步在实践中形成一些 <strong>设计和开发规范</strong></li>
<li>负责定期CR线上服务代码，及时发现可优化的代码段，并发起优化流程直至优化完成</li>
<li>参与核心模块和所有C端模块的设计评审，发现问题并给出指导意见</li>
<li>组织定期的学习和分享(每个Q一次，在评判结果announce之后），提升整个团队的性能优化能力</li>
<li>配合QA制定性能测试方案，根据测试结果提出优化方案，并跟进到底直至落地到线上</li>
<li>带领所有同学养成看性能数据的日常习惯，根据服务性能的各项指标及早的发现和解决问题，避免问题放大</li>
</ol>
<p>杂七杂八的事情不少呵呵。</p>
<h1>速度优化任务拆解</h1>
<p>全盘摸底，只知道慢，有多慢，慢在什么环节，要尽快分析下，并且建立速度的监控体系，速度性能要直观可见，速度优化结果要有理可依，TODO：</p>
<ul>
<li>指定性能评判标准</li>
<li>建立速度指标监控</li>
<li>对目前问题作出详尽的分析</li>
</ul>
<p>快速调研下各种优化方案，这个公司内部做过的太多了，各种前后端方案能快速迁移的方案就快速迁移，TODO：</p>
<ul>
<li>公司内外速度优化方案调研</li>
</ul>
<p>流程规范下，之前更多的关注的是业务层面的事情，性能问题除非异常恶劣，研发测试都很少关注，要改变下流程和制度:</p>
<ul>
<li>梳理前后端重要页面接口，QA加入性能测试</li>
<li>系统设计过评审</li>
</ul>
<p>起始篇到此为止，后续记录具体的工作</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/15/time-machine-on-samba/" itemprop="url">
                  用Samba把TimeMachine备份在windows服务器上
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-15T20:11:18+08:00" content="2016-08-15">
              2016-08-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mac/" itemprop="url" rel="index">
                    <span itemprop="name">mac</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/15/time-machine-on-samba/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/15/time-machine-on-samba/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Mac的TimeMachine备份只支持AFP协议，所以默认情况下是没有办法备份在windows共享里面的，不过可以曲线救国下，通过备份在磁盘镜像<a href="https://zh.wikipedia.org/wiki/%E7%A8%80%E7%96%8F%E7%A3%81%E7%9B%98%E6%98%A0%E5%83%8F" target="_blank" rel="external">稀疏磁盘</a>的方式，备份在windows上</p>
<h1>创建磁盘镜像</h1>
<p>这里要创建的不是常见的DMG镜像，而是稀疏捆绑磁盘镜像<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，目的是稀疏捆绑磁盘镜像是随着使用占用的空间而逐渐增大，不用一下子就把空间分好了，另外后期也可以动态调整大小，另外还有个分不清的叫稀疏磁盘镜像也可以，不过我选择的是稀疏磁盘捆绑镜像<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p>
<p>有2种方式来创建稀疏捆绑磁盘镜像</p>
<ul>
<li>命令行方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">hdiutil create -size 600g -type SPARSEBUNDLE -fs &quot;HFS+J&quot; TimeMachine.sparsebundle</span><br></pre></td></tr></table></figure>
<ul>
<li>通过磁盘工具</li>
</ul>
<p>打开磁盘工具(spotlight搜下磁盘就出来了)，在文件新建-&gt;新建空白映像里面新建个，需要修改映像格式为稀疏捆绑磁盘映像，大小修改下自己写个数字可以写500gb这种mac会自动识别</p>
<h1>把磁盘镜像拷贝到网络驱动上</h1>
<p>打开finder CMD+K smb://你的ip地址，然后把生成的镜像拷贝到你的windows共享中，并且双击下镜像文件mount下</p>
<h1>把这个镜像设置成你的TimeMachine备份设备</h1>
<p>开个终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tmutil setdestination /Volumes/TimeMachine</span><br></pre></td></tr></table></figure>
<p>注意看你的volume目录是不是这个目录，可以cd到volume目录里面查看，替换成自己的</p>
<h1>设置成开机自动连接</h1>
<p>通过applescript的方式实现：<br>
打开脚本编辑器(spotlight 搜applescript)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">try</span><br><span class="line">	mount volume &quot;smb://readyshare/TimeMachine&quot;</span><br><span class="line">end try</span><br><span class="line"></span><br><span class="line">do shell script &quot;hdiutil attach -mountpoint /Volumes/TimeMachine/ /Volumes/TimeMachine/TimeMachine.sparsebundle&quot;</span><br></pre></td></tr></table></figure>
<h1>不足之处</h1>
<p>这种方式不能使用可以恢复到任意时刻的<a href="https://support.apple.com/zh-cn/HT201314" target="_blank" rel="external">OSX的恢复功能</a>，只能先重装个系统，然后mount上镜像，再恢复，当然可以把镜像拷贝到移动硬盘上，插到mac上这样应该也可以使用OSX的恢复功能</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://zh.wikipedia.org/wiki/%E7%A8%80%E7%96%8F%E7%A3%81%E7%9B%98%E6%98%A0%E5%83%8F" target="_blank" rel="external">https://zh.wikipedia.org/wiki/稀疏磁盘映像</a> <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://www.v2ex.com/t/240799" target="_blank" rel="external">https://www.v2ex.com/t/240799</a> <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/12/xhprof/" itemprop="url">
                  使用xhprof进行性能分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-12T15:18:11+08:00" content="2016-08-12">
              2016-08-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/性能/" itemprop="url" rel="index">
                    <span itemprop="name">性能</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/12/xhprof/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/12/xhprof/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1>XHProf 简介</h1>
<p>XHProf 是一个轻量级的分层性能测量分析器。 可以追踪一个请求程序内部各函数的调用次数，消耗时间以及资源占用等信息，是我们进行性能分析的利器。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<h1>XHProf 安装</h1>
<p>首先要安装个extension <a href="http://xhprof.so" target="_blank" rel="external">xhprof.so</a> 并且配置启用，由于我用的环境默认带了，这里不具体描述</p>
<p>装完so之后还要down下xhprof的php lib 文件，可以直接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/phacility/xhprof.git</span><br></pre></td></tr></table></figure>
<p>把这个目录丢到webroot里面(便于之后访问分析结果文件)或者其他地方都行</p>
<h1>XHProf 使用</h1>
<p>主要是在需要进行性能分析的地方 include xhprof的代码，enable 然后disable下，记录下调用情况；AP程序可以残暴点 直接写在index.php 里面，具体示例代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">xhprof_enable(XHPROF_FLAGS_CPU + XHPROF_FLAGS_MEMORY);</span><br><span class="line">//your code</span><br><span class="line">//$objResponse = $objApplication-&gt;bootstrap()-&gt;run();</span><br><span class="line">$data = xhprof_disable(); //返回运行数据</span><br><span class="line"></span><br><span class="line">// xhprof_lib在下载的包里存在这个目录,记得将目录包含到运行的php代码中</span><br><span class="line">$XHPROF_ROOT = __DIR__ . &apos;/../vendor/facebook/xhprof/&apos;; //设置成自己的地址</span><br><span class="line">include_once $XHPROF_ROOT . &apos;/xhprof_lib/utils/xhprof_lib.php&apos;;</span><br><span class="line">include_once $XHPROF_ROOT . &apos;/xhprof_lib/utils/xhprof_runs.php&apos;;</span><br><span class="line">$objXhprofRun = new XHProfRuns_Default();</span><br><span class="line">// 第一个参数j是xhprof_disable()函数返回的运行信息</span><br><span class="line">// 第二个参数是自定义的命名空间字符串(任意字符串),</span><br><span class="line">// 返回运行ID,用这个ID查看相关的运行结果</span><br><span class="line">$run_id = $objXhprofRun-&gt;save_run($data, &quot;xhprof&quot;);</span><br><span class="line">//var_dump($run_id);</span><br><span class="line">echo &quot;http://localhost/xhprof/xhprof_html/index.php?run=&#123;$run_id&#125;&amp;source=xhprof_testing\n&quot;</span><br></pre></td></tr></table></figure>
<h1>XHProf结果分析</h1>
<p>直接在浏览器里面打开xhprof_html的页面，如果不是用web服务器配置的话，可以简单点直接在xhprof 同层目录里面 php -S 0.0.0.0:8888 然后访问 <a href="http://hostname:8888/xhprof/xhprof_html/" target="_blank" rel="external">http://hostname:8888/xhprof/xhprof_html/</a></p>
<p>下面是页面中各字段解释：<br>
我主要用于速度调忧，所以看的比较多的是前几个，调用次数 消耗时间等另外可以看看生成的graph 函数的调用逻辑以及消耗时间，帮助定位问题</p>
<blockquote><p>Function Name 函数名<br>
Calls 调用次数<br>
Calls% 调用百分比<br>
Incl. Wall Time (microsec) 调用的包括子函数所有花费时间 以微秒算(一百万分之一秒)<br>
IWall% 调用的包括子函数所有花费时间的百分比<br>
Excl. Wall Time (microsec) 函数执行本身花费的时间，不包括子树执行时间,以微秒算(一百万分之一秒)<br>
EWall% 函数执行本身花费的时间的百分比，不包括子树执行时间<br>
Incl. CPU(microsecs) 调用的包括子函数所有花费的cpu时间。减Incl. Wall Time即为等待cpu的时间<br>
减Excl. Wall Time即为等待cpu的时间<br>
ICpu% Incl. CPU(microsecs)的百分比<br>
Excl. CPU(microsec) 函数执行本身花费的cpu时间，不包括子树执行时间,以微秒算(一百万分之一秒)。<br>
ECPU% Excl. CPU(microsec)的百分比<br>
Incl.MemUse(bytes) 包括子函数执行使用的内存。<br>
IMemUse% Incl.MemUse(bytes)的百分比<br>
Excl.MemUse(bytes) 函数执行本身内存,以字节算<br>
EMemUse% Excl.MemUse(bytes)的百分比<br>
Incl.PeakMemUse(bytes) Incl.MemUse的峰值<br>
IPeakMemUse% Incl.PeakMemUse(bytes) 的峰值百分比<br>
Excl.PeakMemUse(bytes) Excl.MemUse的峰值<br>
EPeakMemUse% EMemUse% 峰值百分比</p>
</blockquote>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>具体介绍见 <a href="http://php.net/manual/zh/book.xhprof.php" target="_blank" rel="external">PHP官方文档</a> <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/27/install-hexo/" itemprop="url">
                  安装hexo
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-27T18:14:52+08:00" content="2016-04-27">
              2016-04-27
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/27/install-hexo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/04/27/install-hexo/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>安装npm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO- https://raw.github.com/creationix/nvm/master/install.sh | sh</span><br><span class="line">$ NVM_NODEJS_ORG_MIRROR=https://npm.taobao.org/mirrors/node nvm install 4.3.1</span><br></pre></td></tr></table></figure>
<p>安装hexo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli --registry=https://registry.npm.taobao.org --disturl=https://npm.taobao.org/mirrors/node</span><br></pre></td></tr></table></figure>
<p>安装cnpm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm --registry=https://registry.npm.taobao.org install cnpm -g</span><br></pre></td></tr></table></figure>
<p>初始化环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo init blog</span><br><span class="line">cnpm  install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<p>安装必要插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">npm un hexo-renderer-marked --save</span><br><span class="line">npm i hexo-renderer-markdown-it --save</span><br><span class="line"></span><br><span class="line">cd node_modules/hexo-renderer-markdown-it/</span><br><span class="line">npm install markdown-it-footnote --save #添加脚注</span><br><span class="line">npm install markdown-it-emoji --save #添加 Eomji</span><br><span class="line">npm install markdown-it-sub --save #添加下标</span><br><span class="line">npm install markdown-it-sup --save #添加下标</span><br></pre></td></tr></table></figure>
<p>修改配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yml</span><br><span class="line">markdown:</span><br><span class="line">  render:</span><br><span class="line">    html: true</span><br><span class="line">    xhtmlOut: false</span><br><span class="line">    breaks: true</span><br><span class="line">    linkify: true</span><br><span class="line">    typographer: true</span><br><span class="line">    quotes: &apos;“”‘’&apos;</span><br><span class="line">  plugins:</span><br><span class="line">    - markdown-it-abbr</span><br><span class="line">    - markdown-it-footnote</span><br><span class="line">    - markdown-it-ins</span><br><span class="line">    - markdown-it-sub</span><br><span class="line">    - markdown-it-sup</span><br><span class="line">  anchors:</span><br><span class="line">    level: 2</span><br><span class="line">    collisionSuffix: &apos;v&apos;</span><br><span class="line">    permalink: true</span><br><span class="line">    permalinkClass: header-anchor</span><br><span class="line">    permalinkSymbol: ¶</span><br></pre></td></tr></table></figure>
<p>从别的电脑使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.git clone xxx</span><br><span class="line">2.git checkout hexo</span><br><span class="line">3.hexo xxx</span><br><span class="line">4.git push</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/default_avatar.jpg"
               alt="lovejoy" />
          <p class="site-author-name" itemprop="name">lovejoy</p>
          <p class="site-description motion-element" itemprop="description">这是个简介</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">29</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lovejoy" target="_blank" title="Github">
                  
                    <i class="fa fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/liangyongqing" target="_blank" title="Twitter">
                  
                    <i class="fa fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lovejoy</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i> UV<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i> PV<span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'tucao';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  



  
  
  

  

  

</body>
</html>
